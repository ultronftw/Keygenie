"use strict";var me=Object.create;var J=Object.defineProperty;var ke=Object.getOwnPropertyDescriptor;var xe=Object.getOwnPropertyNames;var ye=Object.getPrototypeOf,Ee=Object.prototype.hasOwnProperty;var v=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports);var _e=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of xe(e))!Ee.call(s,n)&&n!==t&&J(s,n,{get:()=>e[n],enumerable:!(r=ke(e,n))||r.enumerable});return s};var Te=(s,e,t)=>(t=s!=null?me(ye(s)):{},_e(e||!s||!s.__esModule?J(t,"default",{value:s,enumerable:!0}):t,s));var Y=v(x=>{"use strict";Object.defineProperty(x,"__esModule",{value:!0});x.bytePairEncode=x.BinaryMap=x.binaryMapKey=void 0;var ve=(s,e,t)=>{let r=t-e,n=16777215>>>Math.max(0,(3-r)*8),o=(s[e+0]|s[e+1]<<8|s[e+2]<<16)&n,i=16777215>>>Math.min(31,Math.max(0,(6-r)*8)),c=(s[e+3]|s[e+4]<<8|s[e+5]<<16)&i;return o+16777216*c};x.binaryMapKey=ve;var U=class s{constructor(){this.nested=new Map,this.final=new Map}get(e,t=0,r=e.length){let n=r<6+t,o=(0,x.binaryMapKey)(e,t,r);return n?this.final.get(o):this.nested.get(o)?.get(e,6+t,r)}set(e,t){let r=(0,x.binaryMapKey)(e,0,e.length);if(e.length<6){this.final.set(r,t);return}let o=this.nested.get(r);if(o instanceof s)o.set(e.subarray(6),t);else{let i=new s;i.set(e.subarray(6),t),this.nested.set(r,i)}}};x.BinaryMap=U;var k=new Int32Array(128),f=new Int32Array(128);function we(s,e,t){if(t===1)return[e.get(s)];let r=2147483647,n=-1;for(;k.length<t*2;)f=new Int32Array(f.length*2),k=new Int32Array(k.length*2);for(let a=0;a<t-1;a++){let u=e.get(s,a,a+2)??2147483647;u<r&&(r=u,n=a),f[a]=a,k[a]=u}f[t-1]=t-1,k[t-1]=2147483647,f[t]=t,k[t]=2147483647;let o=t+1;function i(a,u=0){if(a+u+2<o){let l=e.get(s,f[a],f[a+u+2]);if(l!==void 0)return l}return 2147483647}for(;r!==2147483647;){k[f[n]]=i(n,1),n>0&&(k[f[n-1]]=i(n-1,1));for(let a=n+1;a<o-1;a++)f[a]=f[a+1];o--,n=-1,r=2147483647;for(let a=0;a<o-1;a++){let u=k[f[a]];k[f[a]]<r&&(r=u,n=a)}}let c=[];for(let a=0;a<o-1;a++)c.push(e.get(s,f[a],f[a+1]));return c}x.bytePairEncode=we});var Z=v(N=>{"use strict";Object.defineProperty(N,"__esModule",{value:!0});N.makeTextEncoder=void 0;var j=class{constructor(){this.length=0,this.encoder=new TextEncoder}encode(e){let t=this.encoder.encode(e);return this.length=t.length,t}},$=class{constructor(){this.buffer=Buffer.alloc(256),this.length=0}encode(e){for(;;){if(this.length=this.buffer.write(e,"utf8"),this.length<this.buffer.length-4)return this.buffer;this.buffer=Buffer.alloc(this.length*2),this.length=this.buffer.write(e)}}},Me=()=>typeof Buffer<"u"?new $:new j;N.makeTextEncoder=Me});var ee=v(L=>{"use strict";Object.defineProperty(L,"__esModule",{value:!0});L.LRUCache=void 0;var C=class{constructor(e){this.size=e,this.nodes=new Map}get(e){let t=this.nodes.get(e);if(t)return this.moveToHead(t),t.value}set(e,t){let r=this.nodes.get(e);if(r)r.value=t,this.moveToHead(r);else{let n=new H(e,t);this.nodes.set(e,n),this.addNode(n),this.nodes.size>this.size&&(this.nodes.delete(this.tail.key),this.removeNode(this.tail))}}moveToHead(e){this.removeNode(e),e.next=void 0,e.prev=void 0,this.addNode(e)}addNode(e){this.head&&(this.head.prev=e,e.next=this.head),this.tail||(this.tail=e),this.head=e}removeNode(e){e.prev?e.prev.next=e.next:this.head=e.next,e.next?e.next.prev=e.prev:this.tail=e.prev}};L.LRUCache=C;var H=class{constructor(e,t){this.key=e,this.value=t}}});var G=v(S=>{"use strict";Object.defineProperty(S,"__esModule",{value:!0});S.TikTokenizer=void 0;var Ne=require("fs"),Le=require("util"),B=Y(),Be=Z(),Se=ee();function Pe(s){let e=new Map;try{let r=Ne.readFileSync(s,"utf-8");return t(r),e}catch(r){throw new Error(`Failed to load from BPE encoder file stream: ${r}`)}function t(r){for(let n of r.split(/[\r\n]+/)){if(n.trim()==="")continue;let o=n.split(" ");if(o.length!==2)throw new Error("Invalid format in the BPE encoder file stream");let i=new Uint8Array(Buffer.from(o[0],"base64")),c=parseInt(o[1]);if(!isNaN(c))e.set(i,c);else throw new Error(`Can't parse ${o[1]} to integer`)}}}function Fe(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var V=class{constructor(e,t,r,n=8192){this.textEncoder=(0,Be.makeTextEncoder)(),this.textDecoder=new Le.TextDecoder("utf-8"),this.cache=new Se.LRUCache(n);let o=typeof e=="string"?Pe(e):e;this.init(o,t,r)}init(e,t,r){this.encoder=new B.BinaryMap;for(let[n,o]of e)this.encoder.set(n,o);this.regex=new RegExp(r,"gu"),this.specialTokensRegex=new RegExp(Array.from(t.keys()).map(n=>Fe(n)).join("|")),this.specialTokensEncoder=t,this.decoder=new Map;for(let[n,o]of e)this.decoder.set(o,n);if(e.size!==this.decoder.size)throw new Error("Encoder and decoder sizes do not match");this.specialTokensDecoder=new Map;for(let[n,o]of t)this.specialTokensDecoder.set(o,n)}findNextSpecialToken(e,t,r){let n=t,o=null;if(r&&this.specialTokensRegex)for(;o=e.slice(n).match(this.specialTokensRegex),!(!o||r&&r.includes(o[0]));)n+=o.index+1;let i=o?n+o.index:e.length;return[o,i]}encode(e,t){let r=[],n=0;for(;;){let o,i;if([o,i]=this.findNextSpecialToken(e,n,t),i>n&&this.encodeByIndex(e,r,n,i),o){if(n=n+this.encodeSpecialToken(r,o),n>=e.length)break}else break}return r}encodeSpecialToken(e,t){let r=this.specialTokensEncoder?.get(t[0]);return e.push(r),t.index+t[0].length}encodeByIndex(e,t,r,n){let o,i=e.substring(r,n);for(this.regex.lastIndex=0;o=this.regex.exec(i);){let c=this.cache.get(o[0]);if(c)for(let a of c)t.push(a);else{let a=this.textEncoder.encode(o[0]),u=this.encoder.get(a,0,this.textEncoder.length);if(u!==void 0)t.push(u),this.cache.set(o[0],[u]);else{let l=(0,B.bytePairEncode)(a,this.encoder,this.textEncoder.length);for(let b of l)t.push(b);this.cache.set(o[0],l)}}}}encodeTrimSuffixByIndex(e,t,r,n,o,i,c){let a,u=e.substring(r,n);for(this.regex.lastIndex=0;a=this.regex.exec(u);){let l=a[0],b=this.cache.get(l);if(b)if(i+b.length<=o)i+=b.length,c+=l.length,t.push(...b);else{let p=o-i;i+=p,c+=l.length,t.push(...b.slice(0,p));break}else{let p=this.textEncoder.encode(l),g=this.encoder.get(p,0,p.length);if(g!==void 0)if(this.cache.set(l,[g]),i+1<=o)i++,c+=l.length,t.push(g);else break;else{let y=(0,B.bytePairEncode)(p,this.encoder,this.textEncoder.length);if(this.cache.set(l,y),i+y.length<=o){i+=y.length,c+=l.length;for(let T of y)t.push(T)}else{let T=o-i;i+=T,c+=l.length;for(let m=0;m<T;m++)t.push(y[m]);break}}}if(i>=o)break}return{tokenCount:i,encodeLength:c}}encodeTrimSuffix(e,t,r){let n=[],o=0,i=0,c=0;for(;;){let u,l;if([u,l]=this.findNextSpecialToken(e,o,r),l>o){let{tokenCount:b,encodeLength:p}=this.encodeTrimSuffixByIndex(e,n,o,l,t,i,c);if(i=b,c=p,i>=t)break}if(u!==null){if(i++,i<=t&&(o=o+this.encodeSpecialToken(n,u),c+=u[0].length,o>=e.length)||i>=t)break}else break}let a=c===e.length?e:e.slice(0,c);return{tokenIds:n,text:a}}encodeTrimPrefix(e,t,r){let n=[],o=0,i=0,c=0,a=new Map;for(a.set(i,c);;){let p,g;if([p,g]=this.findNextSpecialToken(e,o,r),g>o){let y,T=e.substring(o,g);for(this.regex.lastIndex=0;y=this.regex.exec(T);){let m=y[0],D=this.cache.get(m);if(D)i+=D.length,c+=m.length,n.push(...D),a.set(i,c);else{let Q=this.textEncoder.encode(m),z=this.encoder.get(Q);if(z!==void 0)this.cache.set(m,[z]),i++,c+=m.length,n.push(z),a.set(i,c);else{let A=(0,B.bytePairEncode)(Q,this.encoder,this.textEncoder.length);this.cache.set(m,A),i+=A.length,c+=m.length;for(let ge of A)n.push(ge);a.set(i,c)}}}}if(p!==null){if(o=o+this.encodeSpecialToken(n,p),i++,c+=p[0].length,a.set(i,c),o>=e.length)break}else break}if(i<=t)return{tokenIds:n,text:e};let u=i-t,l=0,b=0;for(let[p,g]of a)if(p>=u){l=p,b=g;break}if(l>t){let p=this.encode(e,r),g=p.slice(p.length-t);return{tokenIds:g,text:this.decode(g)}}return{tokenIds:n.slice(l),text:e.slice(b)}}decode(e){let t=[];for(let r of e){let n=[],o=this.decoder?.get(r);if(o!==void 0)n=Array.from(o);else{let i=this.specialTokensDecoder?.get(r);if(i!==void 0){let c=this.textEncoder.encode(i);n=Array.from(c.subarray(0,this.textEncoder.length))}}t.push(...n)}return this.textDecoder.decode(new Uint8Array(t))}};S.TikTokenizer=V});var ue=v(d=>{"use strict";Object.defineProperty(d,"__esModule",{value:!0});d.createTokenizer=d.createByEncoderName=d.createByModelName=d.getRegexByModel=d.getRegexByEncoder=d.getSpecialTokensByModel=d.getSpecialTokensByEncoder=d.MODEL_TO_ENCODING=void 0;var F=require("fs"),q=require("path"),Re=G(),Oe=new Map([["gpt-4o-","o200k_base"],["gpt-4-","cl100k_base"],["gpt-3.5-turbo-","cl100k_base"],["gpt-35-turbo-","cl100k_base"]]);d.MODEL_TO_ENCODING=new Map([["gpt-4o","o200k_base"],["gpt-4","cl100k_base"],["gpt-3.5-turbo","cl100k_base"],["text-davinci-003","p50k_base"],["text-davinci-002","p50k_base"],["text-davinci-001","r50k_base"],["text-curie-001","r50k_base"],["text-babbage-001","r50k_base"],["text-ada-001","r50k_base"],["davinci","r50k_base"],["curie","r50k_base"],["babbage","r50k_base"],["ada","r50k_base"],["code-davinci-002","p50k_base"],["code-davinci-001","p50k_base"],["code-cushman-002","p50k_base"],["code-cushman-001","p50k_base"],["davinci-codex","p50k_base"],["cushman-codex","p50k_base"],["text-davinci-edit-001","p50k_edit"],["code-davinci-edit-001","p50k_edit"],["text-embedding-ada-002","cl100k_base"],["text-similarity-davinci-001","r50k_base"],["text-similarity-curie-001","r50k_base"],["text-similarity-babbage-001","r50k_base"],["text-similarity-ada-001","r50k_base"],["text-search-davinci-doc-001","r50k_base"],["text-search-curie-doc-001","r50k_base"],["text-search-babbage-doc-001","r50k_base"],["text-search-ada-doc-001","r50k_base"],["code-search-babbage-code-001","r50k_base"],["code-search-ada-code-001","r50k_base"],["gpt2","gpt2"]]);var P="<|endoftext|>",te="<|fim_prefix|>",re="<|fim_middle|>",ne="<|fim_suffix|>",se="<|endofprompt|>",M="'s|'t|'re|'ve|'m|'ll|'d| ?\\p{L}+| ?\\p{N}+| ?[^\\s\\p{L}\\p{N}]+|\\s+(?!\\S)|\\s+",oe="(?:'s|'S|'t|'T|'re|'RE|'Re|'eR|'ve|'VE|'vE|'Ve|'m|'M|'ll|'lL|'Ll|'LL|'d|'D)|[^\\r\\n\\p{L}\\p{N}]?\\p{L}+|\\p{N}{1,3}| ?[^\\s\\p{L}\\p{N}]+[\\r\\n]*|\\s*[\\r\\n]+|\\s+(?!\\S)|\\s+",Ie=[`[^\r
\\p{L}\\p{N}]?[\\p{Lu}\\p{Lt}\\p{Lm}\\p{Lo}\\p{M}]*[\\p{Ll}\\p{Lm}\\p{Lo}\\p{M}]+(?:'s|'S|'t|'T|'re|'RE|'Re|'eR|'ve|'VE|'vE|'Ve|'m|'M|'ll|'lL|'Ll|'LL|'d|'D)?`,`[^\r
\\p{L}\\p{N}]?[\\p{Lu}\\p{Lt}\\p{Lm}\\p{Lo}\\p{M}]+[\\p{Ll}\\p{Lm}\\p{Lo}\\p{M}]*(?:'s|'S|'t|'T|'re|'RE|'Re|'eR|'ve|'VE|'vE|'Ve|'m|'M|'ll|'lL|'Ll|'LL|'d|'D)?`,"\\p{N}{1,3}"," ?[^\\s\\p{L}\\p{N}]+[\\r\\n/]*","\\s*[\\r\\n]+","\\s+(?!\\S)","\\s+"],ie=Ie.join("|");function X(s){let e="";if(d.MODEL_TO_ENCODING.has(s))e=d.MODEL_TO_ENCODING.get(s);else for(let[t,r]of Oe)if(s.startsWith(t)){e=r;break}return e}async function De(s,e){let t=await fetch(s);if(!t.ok)throw new Error(`Failed to fetch file from ${s}. Status code: ${t.status}`);let r=await t.text();F.writeFileSync(e,r)}function K(s){let e=new Map([[P,50256]]);switch(s){case"o200k_base":e=new Map([[P,199999],[se,200018]]);break;case"cl100k_base":e=new Map([[P,100257],[te,100258],[re,100259],[ne,100260],[se,100276]]);break;case"p50k_edit":e=new Map([[P,50256],[te,50281],[re,50282],[ne,50283]]);break;default:break}return e}d.getSpecialTokensByEncoder=K;function ze(s){let e=X(s);return K(e)}d.getSpecialTokensByModel=ze;function ae(s){switch(s){case"o200k_base":return ie;case"cl100k_base":return oe;default:break}return M}d.getRegexByEncoder=ae;function Ae(s){let e=X(s);return ae(e)}d.getRegexByModel=Ae;async function Ue(s,e=null){return ce(X(s),e)}d.createByModelName=Ue;async function ce(s,e=null){let t,r,n=K(s);switch(s){case"o200k_base":t=ie,r="https://openaipublic.blob.core.windows.net/encodings/o200k_base.tiktoken";break;case"cl100k_base":t=oe,r="https://openaipublic.blob.core.windows.net/encodings/cl100k_base.tiktoken";break;case"p50k_base":t=M,r="https://openaipublic.blob.core.windows.net/encodings/p50k_base.tiktoken";break;case"p50k_edit":t=M,r="https://openaipublic.blob.core.windows.net/encodings/p50k_base.tiktoken";break;case"r50k_base":t=M,r="https://openaipublic.blob.core.windows.net/encodings/r50k_base.tiktoken";break;case"gpt2":t=M,r="https://raw.githubusercontent.com/microsoft/Tokenizer/main/model/gpt2.tiktoken";break;default:throw new Error(`Doesn't support this encoder [${s}]`)}e!==null&&(n=new Map([...n,...e]));let o=q.basename(r),i=q.resolve(__dirname,"..","model");F.existsSync(i)||F.mkdirSync(i,{recursive:!0});let c=q.resolve(i,o);return F.existsSync(c)||(console.log(`Downloading file from ${r}`),await De(r,c),console.log(`Saved file to ${c}`)),le(c,n,t)}d.createByEncoderName=ce;function le(s,e,t,r=8192){return new Re.TikTokenizer(s,e,t,r)}d.createTokenizer=le});var de=v(h=>{"use strict";Object.defineProperty(h,"__esModule",{value:!0});h.createTokenizer=h.createByEncoderName=h.createByModelName=h.getSpecialTokensByModel=h.getSpecialTokensByEncoder=h.getRegexByModel=h.getRegexByEncoder=h.MODEL_TO_ENCODING=h.TikTokenizer=void 0;var je=G();Object.defineProperty(h,"TikTokenizer",{enumerable:!0,get:function(){return je.TikTokenizer}});var E=ue();Object.defineProperty(h,"MODEL_TO_ENCODING",{enumerable:!0,get:function(){return E.MODEL_TO_ENCODING}});Object.defineProperty(h,"getRegexByEncoder",{enumerable:!0,get:function(){return E.getRegexByEncoder}});Object.defineProperty(h,"getRegexByModel",{enumerable:!0,get:function(){return E.getRegexByModel}});Object.defineProperty(h,"getSpecialTokensByEncoder",{enumerable:!0,get:function(){return E.getSpecialTokensByEncoder}});Object.defineProperty(h,"getSpecialTokensByModel",{enumerable:!0,get:function(){return E.getSpecialTokensByModel}});Object.defineProperty(h,"createByModelName",{enumerable:!0,get:function(){return E.createByModelName}});Object.defineProperty(h,"createByEncoderName",{enumerable:!0,get:function(){return E.createByEncoderName}});Object.defineProperty(h,"createTokenizer",{enumerable:!0,get:function(){return E.createTokenizer}})});var be=require("worker_threads");var w=Te(de());var W=class{constructor(){this.listeners=[],this.unexpectedErrorHandler=function(e){setTimeout(()=>{throw e.stack?R.isErrorNoTelemetry(e)?new R(e.message+`

`+e.stack):new Error(e.message+`

`+e.stack):e},0)}}addListener(e){return this.listeners.push(e),()=>{this._removeListener(e)}}emit(e){this.listeners.forEach(t=>{t(e)})}_removeListener(e){this.listeners.splice(this.listeners.indexOf(e),1)}setUnexpectedErrorHandler(e){this.unexpectedErrorHandler=e}getUnexpectedErrorHandler(){return this.unexpectedErrorHandler}onUnexpectedError(e){this.unexpectedErrorHandler(e),this.emit(e)}onUnexpectedExternalError(e){this.unexpectedErrorHandler(e)}},Qe=new W;var R=class s extends Error{constructor(e){super(e),this.name="CodeExpectedError"}static fromError(e){if(e instanceof s)return e;let t=new s;return t.message=e.message,t.stack=e.stack,t}static isErrorNoTelemetry(e){return e.name==="CodeExpectedError"}};var _=class{constructor(){this._n=1;this._val=0}update(e){return this._val=this._val+(e-this._val)/this._n,this._n+=1,this._val}get value(){return this._val}};var $e=globalThis.performance&&typeof globalThis.performance.now=="function",O=class s{static create(e){return new s(e)}constructor(e){this._now=$e&&e===!1?Date.now:globalThis.performance.now.bind(globalThis.performance),this._startTime=this._now(),this._stopTime=-1}stop(){this._stopTime=this._now()}reset(){this._startTime=this._now(),this._stopTime=-1}elapsed(){return this._stopTime!==-1?this._stopTime-this._startTime:this._now()-this._startTime}};var pe=require("fs");function he(s,e){let t=0,r=0,n;do n=s.readUInt8(e+r),t|=(n&127)<<r*7,r++;while(n&128);return{value:t,consumed:r}}var fe=s=>{let e=(0,pe.readFileSync)(s),t=new Map;for(let r=0;r<e.length;){let n=he(e,r);r+=n.consumed,t.set(e.subarray(r,r+n.value),t.size),r+=n.value}return t};var I=class s{constructor(){this._values=[];this._stats={encodeDuration:new _,textLength:new _,callCount:0}}static get instance(){return this._instance||(this._instance=new s),this._instance}init(e,t,r){let n=this._values.length,o=r?fe:i=>i;return this._values.push((0,w.createTokenizer)(o(e),(0,w.getSpecialTokensByEncoder)(t),(0,w.getRegexByEncoder)(t),64e3)),n}encode(e,t,r){let n=O.create(!0),o=this._values[e].encode(t,r);return this._stats.callCount+=1,this._stats.encodeDuration.update(n.elapsed()),this._stats.textLength.update(t.length),o}destroy(e){this._values[e]=void 0}resetStats(){let e=this._stats,t={callCount:e.callCount,encodeDuration:e.encodeDuration.value,textLength:e.textLength.value};return this._stats.encodeDuration=new _,this._stats.textLength=new _,this._stats.callCount=0,t}};function Ce(){let s=be.parentPort;if(!s)throw new Error("This module should only be used in a worker thread.");s.on("message",async e=>{try{let t=await I.instance[e.fn](...e.args);s.postMessage({id:e.id,res:t})}catch(t){s.postMessage({id:e.id,err:t})}})}Ce();
//!!! DO NOT modify, this file was COPIED from 'microsoft/vscode'
